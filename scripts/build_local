#!/usr/bin/env bash
set -euo pipefail

cd "$(dirname "$0")/.."

if ! command -v python3 >/dev/null 2>&1; then
  echo "python3 is required."
  exit 1
fi

VENV_DIR=".venv-build"
if [[ ! -d "$VENV_DIR" ]]; then
  python3 -m venv "$VENV_DIR"
fi

source "$VENV_DIR/bin/activate"
python -m pip install --upgrade pip
python -m pip install pyinstaller
python -m pip install -e .

APP_NAME="Pro Tools Plugin Sync"

python -m PyInstaller \
  --noconfirm \
  --clean \
  --windowed \
  --name "$APP_NAME" \
  --icon "src/pt_plugin_sync/resources/app_icon.icns" \
  --add-data "src/pt_plugin_sync/resources:pt_plugin_sync/resources" \
  src/pt_plugin_sync/menubar_app.py

/usr/libexec/PlistBuddy -c "Add :LSUIElement bool true" "dist/$APP_NAME.app/Contents/Info.plist" 2>/dev/null \
  || /usr/libexec/PlistBuddy -c "Set :LSUIElement true" "dist/$APP_NAME.app/Contents/Info.plist"

DMG_NAME="pro-tools-plugin-sync-local.dmg"
DMG_ROOT="dist/dmg-root"
DMG_RW="dist/pro-tools-plugin-sync-rw.dmg"
rm -rf "$DMG_ROOT"
mkdir -p "$DMG_ROOT"
cp -R "dist/$APP_NAME.app" "$DMG_ROOT/"
ln -s /Applications "$DMG_ROOT/Applications"
cat > "$DMG_ROOT/Fix Gatekeeper.command" <<'EOF'
#!/bin/bash
set -euo pipefail
APP_PATH="/Applications/Pro Tools Plugin Sync.app"
if [[ ! -d "$APP_PATH" ]]; then
  echo "Couldn't find the app in Applications."
  echo "First drag “Pro Tools Plugin Sync.app” into Applications, then run this again."
  exit 1
fi
xattr -dr com.apple.quarantine "$APP_PATH"
echo "Done! You can open Pro Tools Plugin Sync now."
EOF
chmod +x "$DMG_ROOT/Fix Gatekeeper.command"
cat > "$DMG_ROOT/README.txt" <<'EOF'
If macOS says the app is damaged, it was blocked by Gatekeeper.
1) Drag “Pro Tools Plugin Sync.app” into Applications.
2) Double-click “Fix Gatekeeper.command”.
That’s it — the app should open normally now.
EOF

hdiutil create \
  -volname "$APP_NAME" \
  -srcfolder "$DMG_ROOT" \
  -ov -format UDRW \
  "$DMG_RW"

MOUNT_DIR="$(mktemp -d)"
hdiutil attach -readwrite -noverify -noautoopen -mountpoint "$MOUNT_DIR" "$DMG_RW"
case "$MOUNT_DIR" in
  /tmp/*|/private/tmp/*|/var/folders/*|/private/var/folders/*)
    ;;
  *)
    echo "Unexpected DMG mount point: $MOUNT_DIR"
    echo "Refusing to write volume icon outside a temp mount."
    exit 1
    ;;
esac
if [[ "$MOUNT_DIR" == "/" || "$MOUNT_DIR" == "/Volumes" || "$MOUNT_DIR" == "/System/Volumes" || "$MOUNT_DIR" == "/System/Volumes/Data" ]]; then
  echo "Unsafe DMG mount point: $MOUNT_DIR"
  exit 1
fi
cp "src/pt_plugin_sync/resources/app_icon.icns" "$MOUNT_DIR/.VolumeIcon.icns"
if command -v SetFile >/dev/null 2>&1; then
  SetFile -a C "$MOUNT_DIR"
else
  echo "SetFile not found; volume icon may not show."
fi
hdiutil detach "$MOUNT_DIR"
rm -rf "$MOUNT_DIR"

hdiutil convert "$DMG_RW" -format UDZO -ov -o "$DMG_NAME"
rm -f "$DMG_RW"

echo "Built dist/$APP_NAME.app"
echo "Built $DMG_NAME"

APP_PATH="$(pwd)/dist/$APP_NAME.app"
if pgrep -f "$APP_NAME" >/dev/null 2>&1; then
  pkill -f "$APP_NAME" || true
fi
open -n "$APP_PATH" || open "$APP_PATH"
